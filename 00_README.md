# 00-incent.opex.check_main

Главный ноутбук для запуска проверок OpEx по расписанию.

## Назначение

Запускается ежедневно через Airflow DAG и автоматически определяет, какие проверки выполнить на основе настроек из Google Sheets.

## Как работает

1. Загружает конфигурацию из Google Sheets
2. Определяет текущий день недели
3. Для каждой проверки из `NOTEBOOK_MAP`:
   - Проверяет `active_flag == 'Enabled'`
   - Проверяет, что текущий день есть в поле `run`
4. Запускает подходящие ноутбуки через `papermill`
5. После успешных проверок запускает `99-incent.opex.slack_notify.ipynb`
6. Выводит итоговый отчёт со статусами

## Маппинг проверок на ноутбуки

```python
NOTEBOOK_MAP = {
    '01-incent.cr': '01-incent.opex.check_conversion_rates.ipynb',
    '02-incent.p7': '02-incent.opex.check_payers7.ipynb',
    # Добавляйте новые проверки здесь:
    # '03-incent.ltv': '03-incent.opex.check_ltv.ipynb',
}

# Ноутбук для Slack-нотификаций (запускается после всех проверок)
SLACK_NOTIFY_NOTEBOOK = '99-incent.opex.slack_notify.ipynb'
```

## Поле `run` в Google Sheets

Определяет дни недели для запуска проверки.

| Формат | Пример | Описание |
|--------|--------|----------|
| Каждый день | `daily` или `*` | Запуск ежедневно |
| Будни | `weekdays` | Понедельник - Пятница |
| Выходные | `weekends` | Суббота - Воскресенье |
| Один день | `wed` | Только по средам |
| Несколько дней | `mon,wed,fri` | Через запятую |
| JSON массив | `["mon", "wed", "fri"]` | JSON формат |

**Дни недели:** `mon`, `tue`, `wed`, `thu`, `fri`, `sat`, `sun`

## Поле `active_flag`

- `Enabled` — проверка активна
- Любое другое значение — проверка отключена

## Статусы выполнения

| Статус | Иконка | Описание |
|--------|--------|----------|
| `SUCCESS` | ✓ | Проверка выполнена успешно |
| `FAILED` | ✗ | Проверка завершилась с ошибкой |
| `SKIPPED` | ○ | Не запланирована на сегодня |
| `DISABLED` | − | Отключена (`active_flag != Enabled`) |

## Пример вывода

```
Сегодня: 2026-02-04 (TUE)
==================================================

[SKIP] 01-incent.cr: не запланирован на TUE (run=wed)

[RUN] 02-incent.p7 (run=daily)
  Запуск: 02-incent.opex.check_payers7.ipynb...
  [OK] 02-incent.p7 завершён успешно

==================================================
ОТПРАВКА SLACK-НОТИФИКАЦИЙ:
==================================================
  Запуск: 99-incent.opex.slack_notify.ipynb...
  [OK] slack_notify завершён успешно

==================================================
ИТОГИ ЗАПУСКА:
==================================================
  ○ 01-incent.cr: SKIPPED (not scheduled for tue)
  ✓ 02-incent.p7: SUCCESS
  ✓ slack_notify: SUCCESS

Всего: 2 проверок
  Успешно: 1
  Ошибки: 0
  Пропущено: 1
  Отключено: 0

Завершено: 2026-02-04 10:30:45
```

## Таймауты

- Каждый ноутбук имеет таймаут **10 минут** (600 секунд)
- При превышении таймаута проверка получает статус `TIMEOUT`

## Airflow DAG

```python
dag = DAG(
    'incent_opex_checks',
    schedule_interval='0 10 * * *',  # Каждый день в 10:00
    catchup=False,
)
```