
# 03-incent.cpb

–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ (Cost Per Buyer) –¥–ª—è incent-–ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤.

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

| –ù–æ—É—Ç–±—É–∫ | –ö–æ–Ω—Ñ–∏–≥ (name) | –ú–µ—Ç—Ä–∏–∫–∏ |
|---------|---------------|---------|
| `03-incent.opex.check_cpb.ipynb` | `03-incent.cpb` | cpb3, cpb7 |

| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –§–æ—Ä–º—É–ª–∞ |
|---------|----------|---------|
| **cpb3** | –°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ (3 –¥–Ω—è) | spend / payers_3 |
| **cpb7** | –°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ (7 –¥–Ω–µ–π) | spend / payers_7 |

–ê–ª–µ—Ä—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –æ—Ç reference-–ø–µ—Ä–∏–æ–¥–∞.

## –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö

```sql
SELECT app_short, partner_id, operation_segment_nm, country_cd, install_dt,
       spend_discounted_usd_amt, payers_3_cnt, payers_7_cnt, installs_cnt
FROM core.base_metrics
WHERE partner_id IN (...)
  AND install_dt BETWEEN '...' AND '...'
```

## –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

### –ò–∑ Google Sheet (—Å—Ç—Ä–æ–∫–∞ —Å `name = "03-incent.cpb"`)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ü–æ–ª–µ –≤ Sheet | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------------|----------|
| –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å | `active_flag` | `Enabled` / `Disabled` |
| –ö–æ–ª-–≤–æ —Å–∏–≥–º | `n_sigmas` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–º –¥–ª—è CI (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 2.5) |
| –ú–∏–Ω. –∏–Ω—Å—Ç–∞–ª–ª–æ–≤ | `threshold_installs` | –ú–∏–Ω–∏–º—É–º –∏–Ω—Å—Ç–∞–ª–ª–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ |
| –ú–∏–Ω. payers | `threshold_conv` | –ú–∏–Ω–∏–º—É–º payers –≤ –æ–±–æ–∏—Ö –ø–µ—Ä–∏–æ–¥–∞—Ö |
| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | `metric_crit_category` | –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∞–ª–µ—Ä—Ç–∞ (`INFO`, `WARNING`, `CRITICAL`) |
| –ö—Ä–∏—Ç–µ—Ä–∏–π | `criteria` | –ö—Ä–∏—Ç–µ—Ä–∏–π –∞–ª–µ—Ä—Ç–∞: `ci` (–ø–æ CI) –∏–ª–∏ `change` (–ø–æ % –∏–∑–º–µ–Ω–µ–Ω–∏—è) |
| –ü–æ—Ä–æ–≥ WARNING | `threshold_warning` | –ü–æ—Ä–æ–≥ WARNING –¥–ª—è criteria=change (–¥–æ–ª—è, –Ω–∞–ø—Ä. 0.1 = 10%) |
| –ü–æ—Ä–æ–≥ CRITICAL | `threshold_crit` | –ü–æ—Ä–æ–≥ CRITICAL –¥–ª—è criteria=change (–¥–æ–ª—è, –Ω–∞–ø—Ä. 0.2 = 20%) |
| –ù–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ | `notification_flag` | –í–∫–ª—é—á–∏—Ç—å Slack-–Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ |

### –ò–∑ JSON (`config_json`)

```json
{
  "partners": {
    "1000023": "AdJoe",
    "69680625": "Mistplay"
  }
}
```

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –†–∞—Å—á—ë—Ç –ø–µ—Ä–∏–æ–¥–æ–≤

| –û–∫–Ω–æ | Current (–∫–æ–≥–æ—Ä—Ç—ã) | Reference (–∫–æ–≥–æ—Ä—Ç—ã) |
|------|-------------------|---------------------|
| 3d (cpb3) | 3 –¥–Ω—è, –∑–∞–∫—Ä—ã—Ç—ã–µ 4+ –¥–Ω–µ–π –Ω–∞–∑–∞–¥ | 14 –¥–Ω–µ–π –¥–æ current |
| 7d (cpb7) | 3 –¥–Ω—è, –∑–∞–∫—Ä—ã—Ç—ã–µ 8+ –¥–Ω–µ–π –Ω–∞–∑–∞–¥ | 14 –¥–Ω–µ–π –¥–æ current |

### 2. –†–∞—Å—á—ë—Ç CI

| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–∏–ø | –§–æ—Ä–º—É–ª–∞ CI |
|---------|-----|------------|
| cpb3, cpb7 | ratio | `z √ó value √ó sqrt((1 + cv¬≤) / n)` |

–ì–¥–µ:
- `z` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–º (n_sigmas –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
- `cv` ‚Äî –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.5)
- `n` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ payers –≤ reference –ø–µ—Ä–∏–æ–¥–µ

### 3. –õ–æ–≥–∏–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –¥–≤–∞ –∫—Ä–∏—Ç–µ—Ä–∏—è (–ø–∞—Ä–∞–º–µ—Ç—Ä `criteria`):

**criteria = ci** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):
```
is_alert = (current_value < reference_value - ci) OR
           (current_value > reference_value + ci)
alert_category = WARNING
```

**criteria = change**:
```
is_alert = abs(change_perc) >= threshold_warning
alert_category = CRITICAL  –µ—Å–ª–∏ abs(change_perc) >= threshold_crit
                 WARNING   –µ—Å–ª–∏ abs(change_perc) >= threshold_warning
```
CI —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –ë–î, –Ω–æ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞.

### 4. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ threshold

–°—Ä–µ–∑—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è, –µ—Å–ª–∏ **–≤ –ª—é–±–æ–º –∏–∑ –ø–µ—Ä–∏–æ–¥–æ–≤** (current –ò–õ–ò reference) –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —É—Å–ª–æ–≤–∏—è:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –£—Å–ª–æ–≤–∏–µ |
|----------|---------|
| `threshold_installs` | installs >= threshold –≤ –æ–±–æ–∏—Ö –ø–µ—Ä–∏–æ–¥–∞—Ö |
| `threshold_conv` | payers >= threshold –≤ –æ–±–æ–∏—Ö –ø–µ—Ä–∏–æ–¥–∞—Ö |

### 5. –°—Ä–µ–∑—ã –¥–∞–Ω–Ω—ã—Ö

–î–∞–Ω–Ω—ã–µ –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è –ø–æ: `app_short`, `partner_id`, `operation_segment_nm`, `country_cd` + `ALL`

## –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

–ó–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `ma_data.incent_opex_check_universal`:

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|------|----------|
| `check_name` | `03-incent.cpb` |
| `metric` | `cpb3`, `cpb7` |
| `current_value` | –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ CPB (USD) |
| `reference_value` | Reference –∑–Ω–∞—á–µ–Ω–∏–µ CPB |
| `reference_value_ci` | –®–∏—Ä–∏–Ω–∞ CI |
| `change_perc` | –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ |
| `is_alert` | `TRUE` –µ—Å–ª–∏ –≤—ã—Ö–æ–¥ –∑–∞ CI |
| `alert_category` | `WARNING` –µ—Å–ª–∏ –∞–ª–µ—Ä—Ç, –∏–Ω–∞—á–µ `NULL` |

## Slack-–Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```
INCENT.OpEx - 03-incent.cpb (INFO), CPB: üî¥ *AdJoe*

–¢—Ä–µ–¥:
üî∫ FD | ALL | Segment_US | cpb3: $12.50 (+15.2%)
üîª FD | US | Segment_US | cpb7: $14.30 (-8.1%)
```
