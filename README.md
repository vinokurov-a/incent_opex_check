# INCENT OpEx Check

–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –¥–ª—è incent-–ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤.

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

| –ù–æ—É—Ç–±—É–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|------------|
| `00-incent.opex.check_main.ipynb` | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä: –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é |
| `01-incent.opex.check_conversion_rates.ipynb` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–π (CR) |
| `02-incent.opex.check_payers7.ipynb` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–≤ (payers_7) |
| `99-incent.opex.slack_notify.ipynb` | –û—Ç–ø—Ä–∞–≤–∫–∞ Slack-–Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π |

**–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:** `ma_data.incent_opex_check_universal` (—Å–º. [DATABASE.md](DATABASE.md))

---

## 00-incent.opex.check_main

–ì–ª–∞–≤–Ω—ã–π –Ω–æ—É—Ç–±—É–∫ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ OpEx –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —á–µ—Ä–µ–∑ Airflow DAG –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ Google Sheets.

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ Google Sheets
2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
3. –î–ª—è –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑ `NOTEBOOK_MAP`:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `active_flag == 'Enabled'`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –µ—Å—Ç—å –≤ –ø–æ–ª–µ `run`
4. –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –Ω–æ—É—Ç–±—É–∫–∏ —á–µ—Ä–µ–∑ `papermill`
5. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç `99-incent.opex.slack_notify.ipynb`
6. –í—ã–≤–æ–¥–∏—Ç –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏

### –ú–∞–ø–ø–∏–Ω–≥ –ø—Ä–æ–≤–µ—Ä–æ–∫ –Ω–∞ –Ω–æ—É—Ç–±—É–∫–∏

```python
NOTEBOOK_MAP = {
    '01-incent.cr': '01-incent.opex.check_conversion_rates.ipynb',
    '02-incent.p7': '02-incent.opex.check_payers7.ipynb',
    # –î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–µ—Å—å:
    # '03-incent.ltv': '03-incent.opex.check_ltv.ipynb',
}

# –ù–æ—É—Ç–±—É–∫ –¥–ª—è Slack-–Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫)
SLACK_NOTIFY_NOTEBOOK = '99-incent.opex.slack_notify.ipynb'
```

### –ü–æ–ª–µ `run` –≤ Google Sheets

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏.

| –§–æ—Ä–º–∞—Ç | –ü—Ä–∏–º–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|--------|----------|
| –ö–∞–∂–¥—ã–π –¥–µ–Ω—å | `daily` –∏–ª–∏ `*` | –ó–∞–ø—É—Å–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ |
| –ë—É–¥–Ω–∏ | `weekdays` | –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - –ü—è—Ç–Ω–∏—Ü–∞ |
| –í—ã—Ö–æ–¥–Ω—ã–µ | `weekends` | –°—É–±–±–æ—Ç–∞ - –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ |
| –û–¥–∏–Ω –¥–µ–Ω—å | `wed` | –¢–æ–ª—å–∫–æ –ø–æ —Å—Ä–µ–¥–∞–º |
| –ù–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π | `mon,wed,fri` | –ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é |
| JSON –º–∞—Å—Å–∏–≤ | `["mon", "wed", "fri"]` | JSON —Ñ–æ—Ä–º–∞—Ç |

**–î–Ω–∏ –Ω–µ–¥–µ–ª–∏:** `mon`, `tue`, `wed`, `thu`, `fri`, `sat`, `sun`

### –ü–æ–ª–µ `active_flag`

- `Enabled` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
- –õ—é–±–æ–µ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞

### –°—Ç–∞—Ç—É—Å—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

| –°—Ç–∞—Ç—É—Å | –ò–∫–æ–Ω–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|--------|----------|
| `SUCCESS` | ‚úì | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ |
| `FAILED` | ‚úó | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π |
| `SKIPPED` | ‚óã | –ù–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è |
| `DISABLED` | ‚àí | –û—Ç–∫–ª—é—á–µ–Ω–∞ (`active_flag != Enabled`) |

### –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
–°–µ–≥–æ–¥–Ω—è: 2026-02-04 (TUE)
==================================================

[SKIP] 01-incent.cr: –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ TUE (run=wed)

[RUN] 02-incent.p7 (run=daily)
  –ó–∞–ø—É—Å–∫: 02-incent.opex.check_payers7.ipynb...
  [OK] 02-incent.p7 –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ

==================================================
–û–¢–ü–†–ê–í–ö–ê SLACK-–ù–û–¢–ò–§–ò–ö–ê–¶–ò–ô:
==================================================
  –ó–∞–ø—É—Å–∫: 99-incent.opex.slack_notify.ipynb...
  [OK] slack_notify –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ

==================================================
–ò–¢–û–ì–ò –ó–ê–ü–£–°–ö–ê:
==================================================
  ‚óã 01-incent.cr: SKIPPED (not scheduled for tue)
  ‚úì 02-incent.p7: SUCCESS
  ‚úì slack_notify: SUCCESS

–í—Å–µ–≥–æ: 2 –ø—Ä–æ–≤–µ—Ä–æ–∫
  –£—Å–ø–µ—à–Ω–æ: 1
  –û—à–∏–±–∫–∏: 0
  –ü—Ä–æ–ø—É—â–µ–Ω–æ: 1
  –û—Ç–∫–ª—é—á–µ–Ω–æ: 0

–ó–∞–≤–µ—Ä—à–µ–Ω–æ: 2026-02-04 10:30:45
```

### –¢–∞–π–º–∞—É—Ç—ã

- –ö–∞–∂–¥—ã–π –Ω–æ—É—Ç–±—É–∫ –∏–º–µ–µ—Ç —Ç–∞–π–º–∞—É—Ç **10 –º–∏–Ω—É—Ç** (600 —Å–µ–∫—É–Ω–¥)
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ —Ç–∞–π–º–∞—É—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å `TIMEOUT`

### Airflow DAG

```python
dag = DAG(
    'incent_opex_checks',
    schedule_interval='0 10 * * *',  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 10:00
    catchup=False,
)
```

---

## 01-incent.opex.check_conversion_rates

–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω–≤–µ—Ä—Å–∏–π (Conversion Rate) –¥–ª—è incent-–ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤.

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–í—ã—è–≤–ª—è–µ—Ç **—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** –≤ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ (CR = users / installs) –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å:
- **Previous week** ‚Äî –ø—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è
- **Historical average** ‚Äî —Å—Ä–µ–¥–Ω–µ–µ –∑–∞ 4 –Ω–µ–¥–µ–ª–∏ –¥–æ —Ç–µ–∫—É—â–µ–π

–ê–ª–µ—Ä—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ CR (–∫–∞–∫ –≤–≤–µ—Ä—Ö, —Ç–∞–∫ –∏ –≤–Ω–∏–∑).

### –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

#### –ò–∑ Google Sheet (—Å—Ç—Ä–æ–∫–∞ —Å `name = "01-incent.cr"`)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ü–æ–ª–µ –≤ Sheet | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------------|----------|
| `ALERT_ACTIVE_FLAG` | `active_flag` | `Enabled` / `Disabled` ‚Äî –≤–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ |
| `N_SIGMAS` | `n_sigmas` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–º –¥–ª—è –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3.0) |
| `MIN_INSTALLS` | `threshold_installs` | –ú–∏–Ω–∏–º—É–º –∏–Ω—Å—Ç–∞–ª–ª–æ–≤ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ –∞–Ω–∞–ª–∏–∑ |
| `MIN_USERS` | `threshold_fixed` | –ú–∏–Ω–∏–º—É–º —é–∑–µ—Ä–æ–≤ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ –∞–Ω–∞–ª–∏–∑ |
| `ALERT_CATEGORY` | `metric_crit_category` | –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∞–ª–µ—Ä—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `INFO`) |

#### –ò–∑ JSON (`config_json`)

```json
{
  "partner_id": "1000023",
  "countries": ["US", "GB", "DE"],
  "check_countries": true,
  "cw": {
    "7": {
      "default": [1, 2, 3],
      "exceptions": {
        "solitaire": [1, 2]
      }
    },
    "30": {
      "default": [1, 2, 3]
    },
    "90": {
      "default": [1, 2]
    }
  }
}
```

| –ö–ª—é—á | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `partner_id` | ID –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ |
| `countries` | –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ |
| `check_countries` | `true` ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º + ALL; `false` ‚Äî —Ç–æ–ª—å–∫–æ ALL |
| `cw` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ Conversion Windows (7, 30, 90 –¥–Ω–µ–π) |
| `cw.{N}.default` | –£—Ä–æ–≤–Ω–∏ (levels) –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è CW=N |
| `cw.{N}.exceptions` | –ò—Å–∫–ª—é—á–µ–Ω–∏—è: –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å–≤–æ–∏ levels |

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

#### 1. –†–∞—Å—á—ë—Ç –ø–µ—Ä–∏–æ–¥–æ–≤

–î–ª—è –∫–∞–∂–¥–æ–≥–æ CW –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Å–≤–æ–π –ª–∞–≥ (–≤—Ä–µ–º—è –Ω–∞ "—Å–æ–∑—Ä–µ–≤–∞–Ω–∏–µ" –¥–∞–Ω–Ω—ã—Ö):

| CW | Lag (–Ω–µ–¥–µ–ª—å) | –û–ø–∏—Å–∞–Ω–∏–µ |
|----|--------------|----------|
| 7  | 2 | –î–∞–Ω–Ω—ã–µ 2-–Ω–µ–¥–µ–ª—å–Ω–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏ |
| 30 | 5 | –î–∞–Ω–Ω—ã–µ 5-–Ω–µ–¥–µ–ª—å–Ω–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏ |
| 90 | 14 | –î–∞–Ω–Ω—ã–µ 14-–Ω–µ–¥–µ–ª—å–Ω–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏ |

**–ü–µ—Ä–∏–æ–¥—ã:**
- `current_week` ‚Äî —Ç–µ–∫—É—â–∞—è –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º–∞—è –Ω–µ–¥–µ–ª—è (–ü–Ω-–í—Å)
- `previous_week` ‚Äî –Ω–µ–¥–µ–ª—è –ø–µ—Ä–µ–¥ current
- `historical` ‚Äî 4 –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–µ–¥ current (–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ)

#### 2. –õ–æ–≥–∏–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤

–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è reference-–∑–Ω–∞—á–µ–Ω–∏—è:
```
reference_ci = Z * sqrt(reference_cr * (1 - reference_cr) / n_reference)
```

**–ê–ª–µ—Ä—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ—Å–ª–∏** `current_cr` –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã `[reference - ci, reference + ci]`:
```
is_alert = (current_cr < reference_cr - reference_ci) OR
           (current_cr > reference_cr + reference_ci)
```

#### 3. –¢–∏–ø—ã –∞–ª–µ—Ä—Ç–æ–≤

| –ú–µ—Ç—Ä–∏–∫–∞ | alert_category | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------------|----------|
| `previous_cr` | `WARNING` | –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–∏ |
| `historical_cr` | `CRITICAL` | –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ 4-–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ |

### –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `ma_data.incent_opex_check_universal`:

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|------|----------|
| `check_name` | `01-incent.cr` |
| `metric` | `previous_cr` –∏–ª–∏ `historical_cr` |
| `slice1` | country (`US`, `DE`, `ALL` –∏ —Ç.–¥.) |
| `slice2` | level (`1`, `7`, `30` –∏ —Ç.–¥.) |
| `slice3` | cw (`7`, `30`, `90`) |
| `current_value` | –¢–µ–∫—É—â–µ–µ CR |
| `reference_value` | Reference CR |
| `reference_value_ci` | –®–∏—Ä–∏–Ω–∞ CI |
| `change_perc` | –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ |
| `alert_category` | `WARNING` / `CRITICAL` / `NULL` |
| `is_alert` | `TRUE` / `FALSE` |

### –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö

```sql
SELECT * FROM ma_data.vinokurov_cr_data
WHERE partner_id = '...'
  AND country IN (...)
  AND cw = ...
  AND level IN (...)
  AND cohort_date BETWEEN '...' AND '...'
```

---

## 02-incent.opex.check_payers7

–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–≤ (payers_7) –¥–ª—è incent-–ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ —Å –ø–æ—Ä–æ–≥–æ–≤—ã–º–∏ –∞–ª–µ—Ä—Ç–∞–º–∏.

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç **–∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–≤** –∑–∞ –ø–µ—Ä–∏–æ–¥ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∞–ª–µ—Ä—Ç—ã –¥–≤—É—Ö —Ç–∏–ø–æ–≤:
- **WARNING** ‚Äî –º–∞–ª–æ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–≤ –∑–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é
- **CRITICAL** ‚Äî –º–∞–ª–æ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–≤ –∑–∞ 4 –Ω–µ–¥–µ–ª–∏ (—É—Å—Ç–æ–π—á–∏–≤—ã–π —Ç—Ä–µ–Ω–¥)

### –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

#### –ò–∑ Google Sheet (—Å—Ç—Ä–æ–∫–∞ —Å `name = "02-incent.p7"`)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ü–æ–ª–µ –≤ Sheet | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------------|----------|
| `ALERT_ACTIVE_FLAG` | `active_flag` | `Enabled` / `Disabled` ‚Äî –≤–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ |
| `THRESHOLD_WARNING` | `threshold_fixed` | –ü–æ—Ä–æ–≥ –¥–ª—è WARNING (–∑–∞ 1 –Ω–µ–¥–µ–ª—é) |
| `THRESHOLD_CRITICAL` | `threshold_fixed_crit` | –ü–æ—Ä–æ–≥ –¥–ª—è CRITICAL (–∑–∞ 4 –Ω–µ–¥–µ–ª–∏) |
| `ALERT_CATEGORY` | `metric_crit_category` | –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∞–ª–µ—Ä—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `INFO`) |

#### –ò–∑ JSON (`config_json`)

```json
{
  "partners": {
    "1000023": "AdJoe",
    "69680625": "Mistplay",
    "15806": "TapJoy",
    "98667914": "Exmox",
    "71764608": "KashKick",
    "73925639": "Fluent"
  }
}
```

| –ö–ª—é—á | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `partners` | –°–ª–æ–≤–∞—Ä—å: `partner_id` ‚Üí `partner_name` |

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

#### 1. –†–∞—Å—á—ë—Ç –ø–µ—Ä–∏–æ–¥–æ–≤

–ù–µ–¥–µ–ª—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç **–ø—è—Ç–Ω–∏—Ü—ã –¥–æ —á–µ—Ç–≤–µ—Ä–≥–∞** (Fri-Thu).

**–õ–∞–≥ –¥–ª—è —Å–æ–∑—Ä–µ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:** –º–∏–Ω–∏–º—É–º 8 –¥–Ω–µ–π –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ (—á—Ç–æ–±—ã `payers_7` —É—Å–ø–µ–ª–∏ "—Å–æ–∑—Ä–µ—Ç—å").

| –ü–µ—Ä–∏–æ–¥ | –î–Ω–∏ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|--------|-----|---------------|
| –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è | 7 –¥–Ω–µ–π | WARNING |
| 4 –Ω–µ–¥–µ–ª–∏ | 28 –¥–Ω–µ–π | CRITICAL |

#### 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∞–ª–µ—Ä—Ç–∞

```python
def get_alert_type(payers_1w, payers_4w):
    if payers_4w < THRESHOLD_CRITICAL:
        return 'CRITICAL'  # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã—à–µ
    elif payers_1w < THRESHOLD_WARNING:
        return 'WARNING'
    else:
        return None
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** CRITICAL > WARNING

### –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `ma_data.incent_opex_check_universal`:

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|------|----------|
| `check_name` | `02-incent.p7` |
| `metric` | `payers_1w` (WARNING) –∏–ª–∏ `payers_4w` (CRITICAL) |
| `slice1` | `partner_id` |
| `slice2` | `operation_segment_nm` |
| `slice3` | `partner_name` |
| `current_value` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–≤ |
| `reference_value` | –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (threshold) |
| `reference_value_ci` | `NULL` (–Ω–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ) |
| `change_perc` | `(current - threshold) / threshold` |
| `alert_category` | `WARNING` / `CRITICAL` / `NULL` |
| `is_alert` | `TRUE` / `FALSE` |

### –£—Å–ª–æ–≤–∏—è –∞–ª–µ—Ä—Ç–æ–≤

| –¢–∏–ø | –£—Å–ª–æ–≤–∏–µ | –ü–µ—Ä–∏–æ–¥ | –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è |
|-----|---------|--------|---------------|
| **WARNING** | `payers_count < THRESHOLD_WARNING` | 1 –Ω–µ–¥–µ–ª—è | –í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞ |
| **CRITICAL** | `payers_count_4w < THRESHOLD_CRITICAL` | 4 –Ω–µ–¥–µ–ª–∏ | –£—Å—Ç–æ–π—á–∏–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞ |

### –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö

```sql
SELECT * FROM core.base_metrics
WHERE partner_id IN (...)
  AND install_dt BETWEEN '...' AND '...'
  AND operation_segment_nm IN (SELECT ... FROM operation_segments.segments_parameters WHERE ...)
```

–ú–µ—Ç—Ä–∏–∫–∞ `payers_7_cnt = 1` –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≤–µ—Ä—à–∏–ª –ø–ª–∞—Ç—ë–∂ –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏.

---

## 99-incent.opex.slack_notify

–û—Ç–ø—Ä–∞–≤–∫–∞ Slack-–Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π –æ–± –∞–ª–µ—Ä—Ç–∞—Ö.

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∞–ª–µ—Ä—Ç—ã –∏–∑ `ma_data.incent_opex_check_universal` –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ Slack. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫ —á–µ—Ä–µ–∑ `00-incent.opex.check_main.ipynb`.

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ Google Sheets
2. –ß–∏—Ç–∞–µ—Ç –∞–ª–µ—Ä—Ç—ã –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –∏–∑ `ma_data.incent_opex_check_universal` (`is_alert = TRUE`)
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ `check_name`:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `notification_flag == 'Enabled'`
   - –í—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏
4. –í—ã–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏

### SQL-–∑–∞–ø—Ä–æ—Å

```sql
SELECT *
FROM ma_data.incent_opex_check_universal
WHERE date::DATE = '{today}'
  AND is_alert = TRUE
ORDER BY check_name, app, store
```

### –§–æ—Ä–º–∞—Ç –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π

#### 01-incent.cr (Conversion Rate)

**–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:** –ø–æ `app` + `store`

**–û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤ –∫–∞–Ω–∞–ª):**
```
INCENT.OpEx - 01-incent.cr (INFO): *SOLITAIRE (ios)*:
 üî∫ Lvl 1 (cw 7) | CR: 12.34% | Prev (+5.2%)
 üîª Lvl 2 (cw 30) | CR: 8.45% | Hist (-4.8%)
```

**Thread:** –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∞–º (–µ—Å–ª–∏ `check_countries = true`)

#### 02-incent.p7 (Payers)

**–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:** –ø–æ `partner_id`

**–û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤ –∫–∞–Ω–∞–ª):**
```
INCENT.OpEx - 02-incent.p7 (INFO): üî¥ *AdJoe*
```

**Thread (–¥–µ—Ç–∞–ª–∏ –ø–æ app –∏ —Å–µ–≥–º–µ–Ω—Ç–∞–º):**
```
üî¥ [CRITICAL] SOLITAIRE / Segment_A: 15 payers (4 –Ω–µ–¥., threshold: 50)
üü° [WARNING] SOLITAIRE / Segment_B: 8 payers (1 –Ω–µ–¥., threshold: 10)
```

### –ò–∫–æ–Ω–∫–∏

| –¢–∏–ø | –ò–∫–æ–Ω–∫–∞ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|-----|--------|---------------|
| CR –≤–≤–µ—Ä—Ö | üî∫ `:green_triangle_up_alert:` | –†–æ—Å—Ç CR |
| CR –≤–Ω–∏–∑ | üîª `:red_triangle_down_alert:` | –ü–∞–¥–µ–Ω–∏–µ CR |
| CRITICAL | üî¥ `:red_circle:` | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–µ—Ä—Ç payers |
| WARNING | üü° `:large_yellow_circle:` | –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ payers |

### –ü–æ–ª–µ `notification_flag`

- `Enabled` ‚Äî –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- –õ—é–±–æ–µ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π –¥–ª—è –Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `send_<check>_notifications(alerts_df, config_row)` –≤ –Ω–æ—É—Ç–±—É–∫–µ
2. –î–æ–±–∞–≤—å—Ç–µ –≤—ã–∑–æ–≤ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª:
```python
elif check_name == '03-incent.ltv':
    send_ltv_notifications(check_alerts, config_row)
```

---

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.9+
- `papermill` ‚Äî –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–æ—É—Ç–±—É–∫–æ–≤
- –ú–æ–¥—É–ª—å `env` ‚Äî –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets, Redshift –∏ Slack

---

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ—É—Ç–±—É–∫ `XX-incent.opex.check_<name>.ipynb`
2. –î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É –≤ Google Sheets —Å `name` = `XX-incent.<short_name>`
3. –î–æ–±–∞–≤—å—Ç–µ –º–∞–ø–ø–∏–Ω–≥ –≤ `NOTEBOOK_MAP` –≤ `00-incent.opex.check_main.ipynb`
4. –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ `ma_data.incent_opex_check_universal` (—Å–º. [DATABASE.md](DATABASE.md))
5. –î–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π –≤ `99-incent.opex.slack_notify.ipynb`
