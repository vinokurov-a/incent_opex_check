
# 99-incent.opex.slack_notify

–û—Ç–ø—Ä–∞–≤–∫–∞ Slack-–Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π –æ–± –∞–ª–µ—Ä—Ç–∞—Ö.

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∞–ª–µ—Ä—Ç—ã –∏–∑ `ma_data.incent_opex_check_universal` –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ Slack. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫ —á–µ—Ä–µ–∑ `00-incent.opex.check_main.ipynb`.

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ Google Sheets**
   - –ü–∞—Ä—Å–∏—Ç `config_json` –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
   - –°–æ–±–∏—Ä–∞–µ—Ç `PARTNER_NAMES` (—Å–ª–æ–≤–∞—Ä—å {partner_id: –Ω–∞–∑–≤–∞–Ω–∏–µ})

2. **–ß–∏—Ç–∞–µ—Ç –∞–ª–µ—Ä—Ç—ã –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å** –∏–∑ `ma_data.incent_opex_check_universal`
   - –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫ –ø–æ –∫–∞–∂–¥–æ–º—É `check_name` (–ø–æ –ø–æ–ª—é `date`)
   - –¢–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ —Å `is_alert = TRUE`

3. **–î–ª—è –∫–∞–∂–¥–æ–≥–æ `check_name`:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `notification_flag == 'Enabled'`
   - –í—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏
   - –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –∞–ª–µ—Ä—Ç—ã (–ø–æ app_short –∏–ª–∏ partner_id)
   - –§–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + thread —Å –¥–µ—Ç–∞–ª—è–º–∏

4. **–í—ã–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏**

## SQL-–∑–∞–ø—Ä–æ—Å

–ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–ª–µ—Ä—Ç—ã –∏–∑ **–ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞** –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:

```sql
WITH latest_runs AS (
    SELECT check_name, MAX(DATE_TRUNC('minute', date)) AS max_batch
    FROM ma_data.incent_opex_check_universal
    WHERE date::DATE = '{today}'
    GROUP BY check_name
)
SELECT t.*
FROM ma_data.incent_opex_check_universal t
JOIN latest_runs lr
  ON t.check_name = lr.check_name
  AND DATE_TRUNC('minute', t.date) = lr.max_batch
WHERE t.is_alert = TRUE
ORDER BY t.check_name, t.app_short, t.country, t.segment
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∑–∞ –¥–µ–Ω—å, –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–ª–µ—Ä—Ç—ã –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞.

## –§–æ—Ä–º–∞—Ç –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π

### 01-incent.cr (Conversion Rate)

**–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:** –ø–æ `app_short`

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–ª–µ—Ä—Ç—ã –æ—Ç –æ–±–µ–∏—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (`01-incent.cr_prev` –∏ `01-incent.cr_hist`) –ø–æ–¥ –æ–±—â–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º `01-incent.cr` –≤ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è—Ö.

**–û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤ –∫–∞–Ω–∞–ª):**
```
INCENT.OpEx - 01-incent.cr (INFO): *FD_GP*:
 üî∫ Lvl 1 (cw 7) | CR: 12.34% | Prev (+5.2%)
 üîª Lvl 2 (cw 30) | CR: 8.45% | Hist (-4.8%)
```

**Thread:** –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∞–º (–µ—Å–ª–∏ –≤ –∞–ª–µ—Ä—Ç–∞—Ö –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Å—Ç—Ä–∞–Ω–∞–º–∏, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ ALL)

### 02-incent.p7 (Payers)

**–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:** –ø–æ `partner_id`

**–û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤ –∫–∞–Ω–∞–ª):**
```
INCENT.OpEx - 02-incent.p7 (INFO): üî¥ *AdJoe*
```

**Thread (–¥–µ—Ç–∞–ª–∏ –ø–æ app –∏ —Å–µ–≥–º–µ–Ω—Ç–∞–º):**
```
üî¥ [CRITICAL] SOLITAIRE / Segment_A: 15 payers (4 –Ω–µ–¥., threshold: 50)
üü° [WARNING] SOLITAIRE / Segment_B: 8 payers (1 –Ω–µ–¥., threshold: 10)
```

### 03-incent.cpb / 04-incent.c2p / 05-incent.ret (–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏)

**–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:** –ø–æ `partner_id`

–¢—Ä–∏ **–æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** —Å –ø–æ—Ö–æ–∂–∏–º —Ñ–æ—Ä–º–∞—Ç–æ–º –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π:
- **`send_cpb_notifications()`** ‚Üí CPB (cpb3, cpb7) ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –¥–æ–ª–ª–∞—Ä—ã ($X.XX)
- **`send_c2p_notifications()`** ‚Üí C2P (c2p3, c2p7) ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–æ—Ü–µ–Ω—Ç—ã (X.XX%)
- **`send_ret_notifications()`** ‚Üí Retention (ret3, ret7) ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–æ—Ü–µ–Ω—Ç—ã (X.XX%)

**–û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤ –∫–∞–Ω–∞–ª):**
```
INCENT.OpEx - 03-incent.cpb (INFO), CPB: üî¥ *AdJoe*
```

**Thread (–¥–µ—Ç–∞–ª–∏ –ø–æ app, country, segment):**
```
üî∫ FD_GP | ALL | Segment_US | cpb3: $12.50 (+15.2%)
üîª FD_GP | US | Segment_US | cpb7: $14.30 (-8.1%)
```

**–ü–æ—Ä—è–¥–æ–∫ –≤ thread:** —Å–Ω–∞—á–∞–ª–∞ ALL, –ø–æ—Ç–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã

## –ò–∫–æ–Ω–∫–∏

| –¢–∏–ø | –ò–∫–æ–Ω–∫–∞ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|-----|--------|---------------|
| –ú–µ—Ç—Ä–∏–∫–∞ –≤–≤–µ—Ä—Ö | üî∫ `:green_triangle_up_alert:` | –†–æ—Å—Ç –º–µ—Ç—Ä–∏–∫–∏ |
| –ú–µ—Ç—Ä–∏–∫–∞ –≤–Ω–∏–∑ | üîª `:red_triangle_down_alert:` | –ü–∞–¥–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ |
| CRITICAL | üî¥ `:red_circle:` | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–µ—Ä—Ç / –∑–∞–≥–æ–ª–æ–≤–æ–∫ metrics |
| WARNING | üü° `:large_yellow_circle:` | –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ payers |

## –ü–æ–ª–µ `notification_flag`

- `Enabled` ‚Äî –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- –õ—é–±–æ–µ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

–ö–∞–∂–¥—ã–π —Ç–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–º–µ–µ—Ç **–æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é**:

| Check Name | –§—É–Ω–∫—Ü–∏—è | –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ |
|------------|---------|-------------|-------------|
| `01-incent.cr` | `send_cr_notifications()` | app_short | –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç _prev –∏ _hist |
| `02-incent.p7` | `send_payers_notifications()` | partner_id | –ò–∫–æ–Ω–∫–∏ –ø–æ alert_category |
| `03-incent.cpb` | `send_cpb_notifications()` | partner_id | –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –¥–æ–ª–ª–∞—Ä—ã |
| `04-incent.c2p` | `send_c2p_notifications()` | partner_id | –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–æ—Ü–µ–Ω—Ç—ã |
| `05-incent.ret` | `send_ret_notifications()` | partner_id | –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–æ—Ü–µ–Ω—Ç—ã |

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π –¥–ª—è –Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é** `send_<check>_notifications(alerts_df, config_row)`:
   ```python
   def send_ltv_notifications(alerts_df, config_row):
       """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Slack-–Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤ 06-incent.ltv"""
       ALERT_NAME = '06-incent.ltv'
       ALERT_CATEGORY = config_row['metric_crit_category']

       # –õ–æ–≥–∏–∫–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
       # ...
   ```

2. **–î–æ–±–∞–≤—å—Ç–µ –≤—ã–∑–æ–≤ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª:**
   ```python
   elif check_name == '06-incent.ltv':
       send_ltv_notifications(check_alerts, config_row)
   ```

3. **–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–∏—Ç–µ `PARTNER_NAMES`** –≤ —Å–µ–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥–æ–≤